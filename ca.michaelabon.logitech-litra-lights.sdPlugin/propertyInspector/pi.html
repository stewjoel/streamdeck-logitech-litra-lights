<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name=viewport
        content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover">
    <meta name=apple-mobile-web-app-capable content=yes>
    <meta name=apple-mobile-web-app-status-bar-style content=black>
    <link rel="stylesheet" href="./pi.css" />
    <style>
        input[type="range"] {
            color: deeppink;
            accent-color: deeppink;
        }

        .sdpi-wrapper {
            display: none;
        }
    </style>


    <title>ca.michaelabon.logitechlitra Property Inspector</title>
</head>

<body>
    <div class="sdpi-wrapper" id="ca.michaelabon.logitech-litra-lights.set">
        <form id="property-inspector">
            <div type="range" class="sdpi-item" id="temperature">
                <div class="sdpi-item-label">Temperature</div>
                <div class="sdpi-item-value">
                    <span class="clickable" value="2700">2700</span>
                    <input data-suffix="K" type="range" min="2700" max="6500" step="100" name="temperature"
                        value="3200">
                    <span class="clickable" value="6500">6500</span>
                </div>
            </div>
            <div type="range" class="sdpi-item" id="brightness">
                <div class="sdpi-item-label">Brightness</div>
                <div class="sdpi-item-value">
                    <span class="clickable" value="1">1</span>
                    <input data-suffix="%" type="range" min="1" max="100" name="brightness" value="50">
                    <span class="clickable" value="100">100</span>
                </div>
            </div>
        </form>
    </div>

    <!-- Back Color Cycle: 6 configurable solid color presets -->
    <div class="sdpi-wrapper" id="ca.michaelabon.logitech-litra-lights.back.color">
        <form id="color-cycle-form">
            <div class="sdpi-heading">Color Presets (click to edit)</div>
            <div id="colorPresetsList" style="margin: 0 14px 10px 14px;">
                <!-- Color presets will be rendered here -->
            </div>
        </form>
    </div>

    <!-- Back Gradient Cycle: gradient presets -->
    <div class="sdpi-wrapper" id="ca.michaelabon.logitech-litra-lights.back.presets">
        <form id="presets-form">
            <div class="sdpi-heading">Add New Gradient</div>
            <div class="sdpi-item" type="color">
                <div class="sdpi-item-label">Colors</div>
                <div class="sdpi-item-value" style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="presetColor1" value="#ff00ff" style="width:30px;height:26px;">
                    <input type="color" id="presetColor2" value="#00ffff" style="width:30px;height:26px;">
                    <div id="gradientAddPreview"
                        style="flex:1;height:20px;border-radius:4px;border:1px solid #555;margin-right:4px;"></div>
                    <button class="sdpi-item-value" id="addPresetBtn" style="height:26px;margin:0;">Add</button>
                </div>
            </div>

            <div class="sdpi-heading">Your Gradients</div>
            <div id="presetsList" style="margin: 0 14px 10px 14px; max-height: 200px; overflow-y: auto;">
                <!-- Presets will be listed here -->
            </div>
        </form>
    </div>

    <div class="sdpi-wrapper" id="ca.michaelabon.logitech-litra-lights.off">

    </div>
</body>

<script src="./libs/js/constants.js"></script>
<script src="./libs/js/events.js"></script>
<script src="./libs/js/api.js"></script>
<script src="./libs/js/utils.js"></script>
<script src="./libs/js/property-inspector.js"></script>
<script src="pi.js"></script>

<script>
    const clamp = (num, min, max) => num < min ? min : num > max ? max : num;

    const getRGBFromTemperature = (tmpKelvin) => {
        // All calculations require tmpKelvin \ 100, so only do the conversion once
        tmpKelvin = clamp(tmpKelvin, 1000, 40000) / 100;

        // Note: The R-squared values for each approximation follow each calculation
        return {
            r: tmpKelvin <= 66 ? 255 :
                clamp(329.698727446 * (Math.pow(tmpKelvin - 60, -0.1332047592)), 0, 255),  // .988

            g: tmpKelvin <= 66 ?
                clamp(99.4708025861 * Math.log(tmpKelvin) - 161.1195681661, 0, 255) :      // .996
                clamp(288.1221695283 * (Math.pow(tmpKelvin - 60, -0.0755148492)), 0, 255), // .987

            b: tmpKelvin >= 66 ? 255 :
                tmpKelvin <= 19 ? 0 :
                    clamp(138.5177312231 * Math.log(tmpKelvin - 10) - 305.0447927307, 0, 255)  // .998
        };
    };


    const handleTemperatureChange = (event) => {
        const kelvin = event.currentTarget.value
        const { r, g, b } = getRGBFromTemperature(kelvin)
        event.currentTarget.style.accentColor = `rgb(${r}, ${g}, ${b})`
    }

    const handleBrightnessChange = (event) => {
        let v = parseInt(event.currentTarget.value) * 0.8 + 20
        v = clamp(v, 20, 100)
        event.currentTarget.style.accentColor = `hsl(0, 0%, ${v}%)`
    }

    // ===== Back Color Cycle: 6 preset solid colors =====

    const defaultColorPresets = ['#FF0000', '#00FF00', '#0000FF', '#FF00FF', '#FFFF00', '#00FFFF'];
    let colorPresets = [...defaultColorPresets];

    const updateColorPresetsUI = (presets) => {
        colorPresets = presets || [...defaultColorPresets];
        // Pad to 6 if fewer
        while (colorPresets.length < 6) {
            colorPresets.push('#FFFFFF');
        }
        // Limit to 6
        colorPresets = colorPresets.slice(0, 6);

        const list = document.getElementById('colorPresetsList');
        if (!list) return;
        list.innerHTML = '';

        colorPresets.forEach((color, i) => {
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.alignItems = 'center';
            row.style.marginBottom = '4px';
            row.style.background = '#333';
            row.style.padding = '4px 8px';
            row.style.borderRadius = '4px';

            const label = document.createElement('span');
            label.innerText = `${i + 1}.`;
            label.style.fontSize = '11px';
            label.style.marginRight = '8px';
            label.style.color = '#aaa';
            label.style.width = '16px';

            const swatch = document.createElement('div');
            swatch.style.width = '28px';
            swatch.style.height = '18px';
            swatch.style.borderRadius = '3px';
            swatch.style.border = '1px solid #666';
            swatch.style.background = color;
            swatch.style.marginRight = '8px';

            const input = document.createElement('input');
            input.type = 'color';
            input.value = color;
            input.style.width = '30px';
            input.style.height = '22px';
            input.style.padding = '0';
            input.style.border = '1px solid #555';
            input.style.borderRadius = '3px';
            input.style.cursor = 'pointer';
            input.onchange = (e) => {
                colorPresets[i] = e.target.value;
                swatch.style.background = e.target.value;
                hex.innerText = e.target.value.toUpperCase();
                $PI.setSettings({ colorPresets: colorPresets });
            };

            const hex = document.createElement('span');
            hex.innerText = color.toUpperCase();
            hex.style.fontFamily = 'monospace';
            hex.style.fontSize = '10px';
            hex.style.color = '#d8d8d8';
            hex.style.marginLeft = '8px';
            hex.style.flex = '1';

            row.appendChild(label);
            row.appendChild(swatch);
            row.appendChild(input);
            row.appendChild(hex);
            list.appendChild(row);
        });
    };

    // ===== Back Gradient Cycle: gradient-only presets =====

    let currentPresets = [];

    const updateGradientPreview = () => {
        const c1 = document.getElementById('presetColor1');
        const c2 = document.getElementById('presetColor2');
        const preview = document.getElementById('gradientAddPreview');
        if (c1 && c2 && preview) {
            preview.style.background = `linear-gradient(to right, ${c1.value}, ${c2.value})`;
        }
    };

    const updatePresetsUI = (presets) => {
        currentPresets = presets || [];
        const list = document.getElementById('presetsList');
        if (!list) return;
        list.innerHTML = '';
        currentPresets.forEach((p, i) => {
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.marginBottom = '4px';
            div.style.background = '#333';
            div.style.padding = '4px';
            div.style.borderRadius = '4px';

            const preview = document.createElement('div');
            preview.style.width = '50px';
            preview.style.height = '16px';
            preview.style.borderRadius = '2px';
            preview.style.marginRight = '8px';
            preview.style.background = `linear-gradient(to right, ${p.color}, ${p.color2})`;

            const label = document.createElement('span');
            label.innerText = `${i + 1}`;
            label.style.fontSize = '10px';
            label.style.flex = '1';
            label.style.color = '#aaa';

            const delBtn = document.createElement('button');
            delBtn.innerText = 'Ã—';
            delBtn.style.padding = '0 6px';
            delBtn.style.height = '20px';
            delBtn.style.minHeight = '20px';
            delBtn.onclick = () => {
                currentPresets.splice(i, 1);
                $PI.setSettings({ presets: currentPresets });
                updatePresetsUI(currentPresets);
            };

            div.appendChild(preview);
            div.appendChild(label);
            div.appendChild(delBtn);
            list.appendChild(div);
        });
    };

    // Gradient preview live update
    const presetColor1 = document.getElementById('presetColor1');
    const presetColor2 = document.getElementById('presetColor2');
    if (presetColor1) presetColor1.addEventListener('input', updateGradientPreview);
    if (presetColor2) presetColor2.addEventListener('input', updateGradientPreview);

    const addPresetBtn = document.getElementById('addPresetBtn');
    if (addPresetBtn) {
        addPresetBtn.onclick = (e) => {
            e.preventDefault();
            const color = document.getElementById('presetColor1').value;
            const color2 = document.getElementById('presetColor2').value;
            currentPresets.push({ mode: 'gradient', color, color2 });
            $PI.setSettings({ presets: currentPresets });
            updatePresetsUI(currentPresets);
        };
    }

    $PI.onDidReceiveSettings(({ payload }) => {
        if (payload.settings.presets) {
            updatePresetsUI(payload.settings.presets);
        }
        if (payload.settings.colorPresets) {
            updateColorPresetsUI(payload.settings.colorPresets);
        }
    });

    let temperatureInput = document.querySelector('#temperature input');
    if (temperatureInput) {
        temperatureInput.addEventListener("change", handleTemperatureChange);
        temperatureInput.addEventListener("input", handleTemperatureChange);
    }
    let brightnessInput = document.querySelector('#brightness input');
    if (brightnessInput) {
        brightnessInput.addEventListener("change", handleBrightnessChange);
        brightnessInput.addEventListener("input", handleBrightnessChange);
    }

    (() => {
        let temperatureInput = document.querySelector('#temperature input');
        let brightnessInput = document.querySelector('#brightness input');

        if (temperatureInput) handleTemperatureChange({ currentTarget: temperatureInput });
        if (brightnessInput) handleBrightnessChange({ currentTarget: brightnessInput });
        updateGradientPreview();
    })();
</script>

</html>