<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name=viewport
        content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover">
    <meta name=apple-mobile-web-app-capable content=yes>
    <meta name=apple-mobile-web-app-status-bar-style content=black>
    <link rel="stylesheet" href="./pi.css" />
    <style>
        input[type="range"] {
            color: deeppink;
            accent-color: deeppink;
        }

        .sdpi-wrapper {
            display: none;
        }
    </style>


    <title>ca.michaelabon.logitechlitra Property Inspector</title>
</head>

<body>
    <div class="sdpi-wrapper" id="ca.michaelabon.logitech-litra-lights.set">
        <form id="property-inspector">
            <div type="range" class="sdpi-item" id="temperature">
                <div class="sdpi-item-label">Temperature</div>
                <div class="sdpi-item-value">
                    <span class="clickable" value="2700">2700</span>
                    <input data-suffix="K" type="range" min="2700" max="6500" step="100" name="temperature"
                        value="3200">
                    <span class="clickable" value="6500">6500</span>
                </div>
            </div>
            <div type="range" class="sdpi-item" id="brightness">
                <div class="sdpi-item-label">Brightness</div>
                <div class="sdpi-item-value">
                    <span class="clickable" value="1">1</span>
                    <input data-suffix="%" type="range" min="1" max="100" name="brightness" value="50">
                    <span class="clickable" value="100">100</span>
                </div>
            </div>
        </form>
    </div>

    <div class="sdpi-wrapper" id="ca.michaelabon.logitech-litra-lights.back.colorpicker">
        <form id="property-inspector">
            <div class="sdpi-item" id="mode-select">
                <div class="sdpi-item-label">Mode</div>
                <div class="sdpi-item-value">
                    <select name="mode" id="colorMode">
                        <option value="solid">Solid Color</option>
                        <option value="gradient">Gradient</option>
                    </select>
                </div>
            </div>
            <div class="sdpi-item" id="color-primary" type="color">
                <div class="sdpi-item-label">Color</div>
                <div class="sdpi-item-value" style="display:flex;align-items:center;gap:8px;">
                    <input type="color" name="color" value="#ff0000" id="colorInput1"
                        style="width:40px;height:26px;padding:0;border:1px solid #555;border-radius:3px;cursor:pointer;">
                    <span id="colorHex1" style="font-family:monospace;color:#d8d8d8;font-size:10px;">#ff0000</span>
                </div>
            </div>
            <div class="sdpi-item" id="color-secondary" type="color" style="display:none;">
                <div class="sdpi-item-label">Color 2</div>
                <div class="sdpi-item-value" style="display:flex;align-items:center;gap:8px;">
                    <input type="color" name="color2" value="#0000ff" id="colorInput2"
                        style="width:40px;height:26px;padding:0;border:1px solid #555;border-radius:3px;cursor:pointer;">
                    <span id="colorHex2" style="font-family:monospace;color:#d8d8d8;font-size:10px;">#0000ff</span>
                </div>
            </div>
            <div class="sdpi-item" id="gradient-preview-container" style="display:none;">
                <div class="sdpi-item-label">Preview</div>
                <div class="sdpi-item-value">
                    <div id="gradientPreview"
                        style="height:20px;border-radius:4px;border:1px solid #555;margin-right:14px;"></div>
                </div>
            </div>
        </form>
    </div>

    <div class="sdpi-wrapper" id="ca.michaelabon.logitech-litra-lights.back.presets">
        <form id="presets-form">
            <div class="sdpi-heading">Add New Preset</div>
            <div class="sdpi-item">
                <div class="sdpi-item-label">Mode</div>
                <div class="sdpi-item-value">
                    <select id="presetMode">
                        <option value="solid">Solid</option>
                        <option value="gradient">Gradient</option>
                    </select>
                </div>
            </div>
            <div class="sdpi-item" type="color">
                <div class="sdpi-item-label">Colors</div>
                <div class="sdpi-item-value" style="display:flex;align-items:center;gap:8px;">
                    <input type="color" id="presetColor1" value="#ff0000" style="width:30px;height:26px;">
                    <input type="color" id="presetColor2" value="#0000ff" style="width:30px;height:26px;display:none;">
                    <button class="sdpi-item-value" id="addPresetBtn" style="height:26px;margin:0;">Add</button>
                </div>
            </div>

            <div class="sdpi-heading">Your Presets</div>
            <div id="presetsList" style="margin: 0 14px 10px 14px; max-height: 200px; overflow-y: auto;">
                <!-- Presets will be listed here -->
            </div>
        </form>
    </div>

    <div class="sdpi-wrapper" id="ca.michaelabon.logitech-litra-lights.off">

    </div>
</body>

<script src="./libs/js/constants.js"></script>
<script src="./libs/js/events.js"></script>
<script src="./libs/js/api.js"></script>
<script src="./libs/js/utils.js"></script>
<script src="./libs/js/property-inspector.js"></script>
<script src="pi.js"></script>

<script>
    const clamp = (num, min, max) => num < min ? min : num > max ? max : num;

    const getRGBFromTemperature = (tmpKelvin) => {
        // All calculations require tmpKelvin \ 100, so only do the conversion once
        tmpKelvin = clamp(tmpKelvin, 1000, 40000) / 100;

        // Note: The R-squared values for each approximation follow each calculation
        return {
            r: tmpKelvin <= 66 ? 255 :
                clamp(329.698727446 * (Math.pow(tmpKelvin - 60, -0.1332047592)), 0, 255),  // .988

            g: tmpKelvin <= 66 ?
                clamp(99.4708025861 * Math.log(tmpKelvin) - 161.1195681661, 0, 255) :      // .996
                clamp(288.1221695283 * (Math.pow(tmpKelvin - 60, -0.0755148492)), 0, 255), // .987

            b: tmpKelvin >= 66 ? 255 :
                tmpKelvin <= 19 ? 0 :
                    clamp(138.5177312231 * Math.log(tmpKelvin - 10) - 305.0447927307, 0, 255)  // .998
        };
    };


    const handleTemperatureChange = (event) => {
        const kelvin = event.currentTarget.value

        console.log("KELVIN", kelvin)

        const { r, g, b } = getRGBFromTemperature(kelvin)

        console.log("rgb", r, g, b)

        console.log("event.currentTarget", event.currentTarget)

        event.currentTarget.style.accentColor = `rgb(${r}, ${g}, ${b})`
    }

    const handleBrightnessChange = (event) => {
        // const v = parseInt(event.currentTarget.value) * 255 / 100

        let v = parseInt(event.currentTarget.value) * 0.8 + 20
        v = clamp(v, 20, 100)


        event.currentTarget.style.accentColor = `hsl(0, 0%, ${v}%)`
    }

    const handleColorChange = () => {
        const mode = document.getElementById('colorMode').value;
        const color1 = document.getElementById('colorInput1').value;
        const color2 = document.getElementById('colorInput2').value;

        document.getElementById('colorHex1').innerText = color1.toUpperCase();
        document.getElementById('colorHex2').innerText = color2.toUpperCase();

        const secondaryItem = document.getElementById('color-secondary');
        const previewItem = document.getElementById('gradient-preview-container');

        if (mode === 'gradient') {
            secondaryItem.style.display = 'flex';
            previewItem.style.display = 'flex';
            document.getElementById('gradientPreview').style.background = `linear-gradient(to right, ${color1}, ${color2})`;
        } else {
            secondaryItem.style.display = 'none';
            previewItem.style.display = 'none';
        }
    };

    let currentPresets = [];

    const updatePresetsUI = (presets) => {
        currentPresets = presets || [];
        const list = document.getElementById('presetsList');
        list.innerHTML = '';
        currentPresets.forEach((p, i) => {
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.marginBottom = '4px';
            div.style.background = '#333';
            div.style.padding = '4px';
            div.style.borderRadius = '4px';

            const preview = document.createElement('div');
            preview.style.width = '40px';
            preview.style.height = '16px';
            preview.style.borderRadius = '2px';
            preview.style.marginRight = '8px';
            if (p.mode === 'gradient') {
                preview.style.background = `linear-gradient(to right, ${p.color}, ${p.color2})`;
            } else {
                preview.style.background = p.color;
            }

            const label = document.createElement('span');
            label.innerText = p.mode === 'gradient' ? 'Grad' : 'Solid';
            label.style.fontSize = '10px';
            label.style.flex = '1';

            const delBtn = document.createElement('button');
            delBtn.innerText = 'Ã—';
            delBtn.style.padding = '0 6px';
            delBtn.style.height = '20px';
            delBtn.style.minHeight = '20px';
            delBtn.onclick = () => {
                currentPresets.splice(i, 1);
                $PI.setSettings({ presets: currentPresets });
                updatePresetsUI(currentPresets);
            };

            div.appendChild(preview);
            div.appendChild(label);
            div.appendChild(delBtn);
            list.appendChild(div);
        });
    };

    document.getElementById('presetMode').onchange = (e) => {
        document.getElementById('presetColor2').style.display = e.target.value === 'gradient' ? 'inline-block' : 'none';
    };

    document.getElementById('addPresetBtn').onclick = (e) => {
        e.preventDefault();
        const mode = document.getElementById('presetMode').value;
        const color = document.getElementById('presetColor1').value;
        const color2 = document.getElementById('presetColor2').value;

        currentPresets.push({ mode, color, color2 });
        $PI.setSettings({ presets: currentPresets });
        updatePresetsUI(currentPresets);
    };

    $PI.onDidReceiveSettings(({ payload }) => {
        if (payload.settings.presets) {
            updatePresetsUI(payload.settings.presets);
        }
    });

    // We also need to catch the initial settings from onConnected
    // Since pi.js might have already run, we can check if settings are available
    // A better way is to hook into the onConnected in a way that doesn't conflict
    // for now let's just let it be handled by onDidReceiveSettings which usually triggers

    let temperatureInput = document.querySelector('#temperature input');
    temperatureInput.addEventListener("change", handleTemperatureChange);
    temperatureInput.addEventListener("input", handleTemperatureChange);
    let brightnessInput = document.querySelector('#brightness input');
    brightnessInput.addEventListener("change", handleBrightnessChange);
    brightnessInput.addEventListener("input", handleBrightnessChange);

    document.getElementById('colorMode').addEventListener('change', handleColorChange);
    document.getElementById('colorInput1').addEventListener('input', handleColorChange);
    document.getElementById('colorInput2').addEventListener('input', handleColorChange);

    (() => {
        let temperatureInput = document.querySelector('#temperature input');
        let brightnessInput = document.querySelector('#brightness input');

        handleTemperatureChange({ currentTarget: temperatureInput });
        handleBrightnessChange({ currentTarget: brightnessInput });
        handleColorChange();
    })();
</script>

</html>